apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: dotnet-pg-microservice-pipeline
  labels:
    app: dotnet-pg-microservice
spec:
  params:
    - name: git-url
      type: string
      description: The Git repository URL
    - name: git-revision
      type: string
      description: The Git revision to build
      default: main
    - name: image-name
      type: string
      description: The fully qualified image name to push
    - name: namespace
      type: string
      description: The OpenShift namespace to deploy to

  workspaces:
    - name: shared-workspace
    - name: docker-credentials

  tasks:
    - name: clone-repo
      taskRef:
        resolver: cluster
        params:
          - name: kind
            value: task
          - name: name
            value: git-clone
          - name: namespace
            value: openshift-pipelines
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
      workspaces:
        - name: output
          workspace: shared-workspace

    - name: build-and-push
      taskRef:
        resolver: cluster
        params:
          - name: kind
            value: task
          - name: name
            value: buildah
          - name: namespace
            value: openshift-pipelines
      runAfter:
        - clone-repo
      params:
        - name: IMAGE
          value: $(params.image-name)
        - name: DOCKERFILE
          value: ./Dockerfile
        - name: CONTEXT
          value: .
      workspaces:
        - name: source
          workspace: shared-workspace
        - name: dockerconfig
          workspace: docker-credentials

    - name: deploy
      taskRef:
        resolver: cluster
        params:
          - name: kind
            value: task
          - name: name
            value: openshift-client
          - name: namespace
            value: openshift-pipelines
      runAfter:
        - build-and-push
      params:
        - name: SCRIPT
          value: |
            oc apply -f k8s/secret.yaml -n $(params.namespace)
            oc apply -f k8s/deployment.yaml -n $(params.namespace)
            oc apply -f k8s/service.yaml -n $(params.namespace)
            oc apply -f k8s/route.yaml -n $(params.namespace)
            oc set image deployment/dotnet-pg-microservice \
              dotnet-pg-microservice=$(params.image-name) \
              -n $(params.namespace)
            oc rollout status deployment/dotnet-pg-microservice \
              -n $(params.namespace) --timeout=120s
      workspaces:
        - name: manifest-dir
          workspace: shared-workspace
